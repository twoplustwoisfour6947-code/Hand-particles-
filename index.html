<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand Tracking Particles</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #050505; font-family: sans-serif; }
        canvas { display: block; }
        #video-container { position: absolute; bottom: 10px; right: 10px; width: 160px; height: 120px; border: 2px solid #444; border-radius: 8px; overflow: hidden; transform: scaleX(-1); }
        video { width: 100%; height: 100%; object-fit: cover; }
        .ui { position: absolute; top: 20px; left: 20px; color: white; pointer-events: none; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div class="ui">
        <h1>Particle Interaction</h1>
        <p>Wave your hands to move the particles.</p>
    </div>

    <div id="video-container">
        <video id="input_video"></video>
    </div>
    <canvas id="particleCanvas"></canvas>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('particleCanvas');
        const canvasCtx = canvasElement.getContext('2d');

        let particles = [];
        let handJoints = [];

        // Resize canvas
        function resize() {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
            initParticles();
        }

        class Particle {
            constructor() {
                this.x = Math.random() * canvasElement.width;
                this.y = Math.random() * canvasElement.height;
                this.baseX = this.x;
                this.baseY = this.y;
                this.size = Math.random() * 3 + 1;
                this.vx = 0;
                this.vy = 0;
                this.friction = 0.95;
                this.ease = 0.05;
                this.color = `hsl(${Math.random() * 60 + 180}, 70%, 60%)`;
            }

            update() {
                // Interaction with tracked hand joints
                handJoints.forEach(joint => {
                    const dx = joint.x - this.x;
                    const dy = joint.y - this.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    const force = (100 - distance) / 100;

                    if (distance < 100) {
                        const angle = Math.atan2(dy, dx);
                        this.vx -= Math.cos(angle) * force * 10;
                        this.vy -= Math.sin(angle) * force * 10;
                    }
                });

                // Return to original position
                this.vx += (this.baseX - this.x) * this.ease;
                this.vy += (this.baseY - this.y) * this.ease;

                this.vx *= this.friction;
                this.vy *= this.friction;

                this.x += this.vx;
                this.y += this.vy;
            }

            draw() {
                canvasCtx.fillStyle = this.color;
                canvasCtx.beginPath();
                canvasCtx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                canvasCtx.fill();
            }
        }

        function initParticles() {
            particles = [];
            const count = (canvasElement.width * canvasElement.height) / 4000;
            for (let i = 0; i < count; i++) {
                particles.push(new Particle());
            }
        }

        function onResults(results) {
            handJoints = [];
            if (results.multiHandLandmarks) {
                for (const landmarks of results.multiHandLandmarks) {
                    // We only track key points (fingertips) to keep it smooth
                    // Indices for fingertips: 4, 8, 12, 16, 20
                    [4, 8, 12, 16, 20].forEach(index => {
                        handJoints.push({
                            x: (1 - landmarks[index].x) * canvasElement.width, // Mirroring x
                            y: landmarks[index].y * canvasElement.height
                        });
                    });
                }
            }
        }

        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
            maxNumHands: 2,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await hands.send({image: videoElement});
            },
            width: 640,
            height: 480
        });

        function animate() {
            canvasCtx.fillStyle = 'rgba(5, 5, 5, 0.2)';
            canvasCtx.fillRect(0, 0, canvasElement.width, canvasElement.height);

            particles.forEach(p => {
                p.update();
                p.draw();
            });

            requestAnimationFrame(animate);
        }

        window.addEventListener('resize', resize);
        resize();
        camera.start();
        animate();
    </script>
</body>
</html>
